<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏïÑÏù¥Ïò®2 Ï†ÑÌà¨Î†• Ìñ•ÏÉÅ AI Í∞ÄÏù¥Îìú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function Aion2PowerGuideApp() {
            const [activeTab, setActiveTab] = useState('search');
            const [servers, setServers] = useState([]);
            const [selectedRace, setSelectedRace] = useState('1'); // 1: Ï≤úÏ°±, 2: ÎßàÏ°±
            const [selectedServer, setSelectedServer] = useState('');
            const [characterName, setCharacterName] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [selectedCharacter, setSelectedCharacter] = useState(null);
            const [characterData, setCharacterData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState('');
            const [analyzing, setAnalyzing] = useState(false);

            const API_URL = window.location.origin;

            // ÏÑúÎ≤Ñ Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
            useEffect(() => {
                fetchServers();
            }, []);

            const fetchServers = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/gameinfo/servers`);
                    const data = await response.json();
                    
                    console.log('Server API Response:', data);
                    
                    // ÏùëÎãµ Íµ¨Ï°∞Ïóê Îî∞Îùº Ï≤òÎ¶¨
                    let serverList = [];
                    
                    if (Array.isArray(data)) {
                        serverList = data;
                    } else if (data.servers) {
                        serverList = data.servers;
                    } else if (data.data) {
                        serverList = data.data;
                    } else if (data.list) {
                        serverList = data.list;
                    }
                    
                    console.log('Processed Server List:', serverList);
                    
                    setServers(serverList);
                    if (serverList.length > 0) {
                        // serverId ÎòêÎäî id ÏÜçÏÑ± ÌôïÏù∏
                        const firstServerId = serverList[0].serverId || serverList[0].id || serverList[0].serverID;
                        setSelectedServer(firstServerId);
                    }
                } catch (error) {
                    console.error('ÏÑúÎ≤Ñ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                    // ÏûÑÏãú ÏÑúÎ≤Ñ Î™©Î°ù (fallback)
                    const fallbackServers = [
                        { id: '1020', name: 'ÏÑúÎ≤Ñ1', serverId: '1020' },
                        { id: '1021', name: 'ÏÑúÎ≤Ñ2', serverId: '1021' }
                    ];
                    setServers(fallbackServers);
                    setSelectedServer('1020');
                }
            };

            // Ï∫êÎ¶≠ÌÑ∞ Í≤ÄÏÉâ
            const searchCharacter = async () => {
                if (!characterName.trim()) {
                    alert('Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                if (!selectedServer) {
                    alert('ÏÑúÎ≤ÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                setLoading(true);
                setSearchResults([]);

                try {
                    const response = await fetch(`${API_URL}/api/character/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            keyword: characterName,
                            race: selectedRace,
                            serverId: selectedServer
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.characters) {
                        setSearchResults(result.data.characters);
                        if (result.data.characters.length === 0) {
                            alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                        }
                    } else {
                        alert('Í≤ÄÏÉâ Ïã§Ìå®: ' + (result.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                    }
                } catch (error) {
                    console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
                    alert('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                } finally {
                    setLoading(false);
                }
            };

            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù Î∞è ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const selectCharacter = async (character) => {
                setSelectedCharacter(character);
                setLoading(true);

                try {
                    const response = await fetch(`${API_URL}/api/character/fetch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            characterId: character.characterId,
                            serverId: selectedServer
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Îç∞Ïù¥ÌÑ∞ Í∞ÄÍ≥µ
                        const processedData = {
                            name: result.info.characterName,
                            level: result.info.level,
                            class: result.info.className,
                            combatPower: result.info.combatPoint,
                            equipment: result.equipment || {},
                            stats: result.info.stats || {},
                            info: result.info,
                            rawEquipment: result.equipment
                        };
                        
                        setCharacterData(processedData);
                        setActiveTab('analysis');
                    } else {
                        alert('Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                } catch (error) {
                    console.error('Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', error);
                    alert('Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                } finally {
                    setLoading(false);
                }
            };

            // AI Î∂ÑÏÑù
            const analyzeCharacter = async () => {
                if (!characterData) return;

                setAnalyzing(true);

                try {
                    const response = await fetch(`${API_URL}/api/character/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(characterData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success) {
                        setAiAnalysis(result.analysis);
                    } else {
                        setAiAnalysis('AI Î∂ÑÏÑù Ïã§Ìå®: ' + result.error);
                    }
                } catch (error) {
                    console.error('AI Î∂ÑÏÑù Ïò§Î•ò:', error);
                    setAiAnalysis('AI Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                } finally {
                    setAnalyzing(false);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        {/* Ìó§Îçî */}
                        <div className="text-center mb-8">
                            <h1 className="text-4xl md:text-5xl font-bold text-white mb-3 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                                ÏïÑÏù¥Ïò®2 Ï†ÑÌà¨Î†• Ìñ•ÏÉÅ AI Í∞ÄÏù¥Îìú
                            </h1>
                            <p className="text-gray-300 text-lg">
                                Ïã§Ï†ú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î°ú AIÍ∞Ä Î∂ÑÏÑùÌïòÎäî ÎßûÏ∂§Ìòï Ï†ÑÌà¨Î†• Ìñ•ÏÉÅ Ï†ÑÎûµ
                            </p>
                        </div>

                        {/* ÌÉ≠ */}
                        <div className="flex gap-2 mb-6 bg-slate-800/50 p-2 rounded-lg backdrop-blur">
                            <button
                                onClick={() => setActiveTab('search')}
                                className={`flex-1 py-3 px-6 rounded-lg font-medium transition-all ${
                                    activeTab === 'search'
                                        ? 'bg-purple-600 text-white shadow-lg'
                                        : 'text-gray-300 hover:bg-slate-700'
                                }`}
                            >
                                Ï∫êÎ¶≠ÌÑ∞ Í≤ÄÏÉâ
                            </button>
                            <button
                                onClick={() => setActiveTab('analysis')}
                                disabled={!characterData}
                                className={`flex-1 py-3 px-6 rounded-lg font-medium transition-all ${
                                    activeTab === 'analysis'
                                        ? 'bg-purple-600 text-white shadow-lg'
                                        : 'text-gray-300 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed'
                                }`}
                            >
                                AI Î∂ÑÏÑù
                            </button>
                        </div>

                        {/* Ï∫êÎ¶≠ÌÑ∞ Í≤ÄÏÉâ ÌÉ≠ */}
                        {activeTab === 'search' && (
                            <div className="bg-slate-800/70 backdrop-blur rounded-2xl p-8 shadow-2xl border border-slate-700">
                                <h2 className="text-2xl font-bold text-white mb-6">Ï∫êÎ¶≠ÌÑ∞ Í≤ÄÏÉâ</h2>
                                
                                {/* Ï¢ÖÏ°± ÏÑ†ÌÉù */}
                                <div className="mb-6">
                                    <label className="block text-gray-300 mb-3 font-medium">Ï¢ÖÏ°±</label>
                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setSelectedRace('1')}
                                            className={`flex-1 py-4 px-6 rounded-lg font-bold transition-all ${
                                                selectedRace === '1'
                                                    ? 'bg-blue-600 text-white shadow-lg scale-105'
                                                    : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                                            }`}
                                        >
                                            ‚ö° Ï≤úÏ°± (Light)
                                        </button>
                                        <button
                                            onClick={() => setSelectedRace('2')}
                                            className={`flex-1 py-4 px-6 rounded-lg font-bold transition-all ${
                                                selectedRace === '2'
                                                    ? 'bg-red-600 text-white shadow-lg scale-105'
                                                    : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                                            }`}
                                        >
                                            üî• ÎßàÏ°± (Dark)
                                        </button>
                                    </div>
                                </div>

                                {/* ÏÑúÎ≤Ñ ÏÑ†ÌÉù */}
                                <div className="mb-6">
                                    <label className="block text-gray-300 mb-2 font-medium">
                                        ÏÑúÎ≤Ñ {servers.length > 0 ? `(${servers.length}Í∞ú)` : ''}
                                    </label>
                                    {servers.length > 0 ? (
                                        <select
                                            value={selectedServer}
                                            onChange={(e) => setSelectedServer(e.target.value)}
                                            className="w-full px-4 py-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-purple-500 focus:outline-none"
                                        >
                                            {servers.map((server) => {
                                                const serverId = server.serverId || server.id || server.serverID;
                                                const serverName = server.name || server.serverName || `ÏÑúÎ≤Ñ ${serverId}`;
                                                return (
                                                    <option key={serverId} value={serverId}>
                                                        {serverName}
                                                    </option>
                                                );
                                            })}
                                        </select>
                                    ) : (
                                        <div className="px-4 py-3 bg-slate-700 text-gray-400 rounded-lg border border-slate-600">
                                            ÏÑúÎ≤Ñ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...
                                        </div>
                                    )}
                                </div>

                                {/* Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ */}
                                <div className="mb-6">
                                    <label className="block text-gray-300 mb-2 font-medium">Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ</label>
                                    <input
                                        type="text"
                                        value={characterName}
                                        onChange={(e) => setCharacterName(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && searchCharacter()}
                                        placeholder="Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ ÏûÖÎ†•"
                                        className="w-full px-4 py-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-purple-500 focus:outline-none"
                                    />
                                </div>

                                <button
                                    onClick={searchCharacter}
                                    disabled={loading}
                                    className="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-bold text-lg hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg disabled:opacity-50"
                                >
                                    {loading ? 'Í≤ÄÏÉâ Ï§ë...' : 'Ï∫êÎ¶≠ÌÑ∞ Í≤ÄÏÉâ'}
                                </button>

                                {/* Í≤ÄÏÉâ Í≤∞Í≥º */}
                                {searchResults.length > 0 && (
                                    <div className="mt-8">
                                        <h3 className="text-xl font-bold text-white mb-4">Í≤ÄÏÉâ Í≤∞Í≥º</h3>
                                        <div className="space-y-3">
                                            {searchResults.map((char, index) => (
                                                <div
                                                    key={index}
                                                    onClick={() => selectCharacter(char)}
                                                    className="p-4 bg-slate-700/50 rounded-lg border border-slate-600 hover:border-purple-500 hover:bg-slate-700 cursor-pointer transition-all"
                                                >
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <div className="text-lg font-bold text-white">{char.characterName}</div>
                                                            <div className="text-sm text-gray-400">
                                                                Lv.{char.level} {char.className}
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm text-gray-400">Ï†ÑÌà¨Î†•</div>
                                                            <div className="text-xl font-bold text-purple-400">
                                                                {char.combatPoint?.toLocaleString() || '-'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* AI Î∂ÑÏÑù ÌÉ≠ */}
                        {activeTab === 'analysis' && characterData && (
                            <div className="bg-slate-800/70 backdrop-blur rounded-2xl p-8 shadow-2xl border border-slate-700">
                                <h2 className="text-2xl font-bold text-white mb-6">AI Ï†ÑÌà¨Î†• Î∂ÑÏÑù</h2>
                                
                                {/* Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏöîÏïΩ */}
                                <div className="mb-8 p-6 bg-slate-700/50 rounded-xl border border-slate-600">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="text-2xl font-bold text-white">{characterData.name}</h3>
                                            <p className="text-gray-400">Lv.{characterData.level} {characterData.class}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-sm text-gray-400">Ï†ÑÌà¨Î†•</p>
                                            <p className="text-3xl font-bold text-purple-400">
                                                {characterData.combatPower?.toLocaleString()}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {!aiAnalysis && (
                                    <div className="text-center py-12">
                                        <div className="mb-6">
                                            <svg className="w-24 h-24 mx-auto text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                            </svg>
                                        </div>
                                        <p className="text-gray-300 mb-6">AIÍ∞Ä Ïã§Ï†ú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Î∂ÑÏÑùÌïòÏó¨<br/>Ï†ÑÌà¨Î†• Ìñ•ÏÉÅ Ï†ÑÎûµÏùÑ Ï†úÏãúÌï©ÎãàÎã§</p>
                                        <button
                                            onClick={analyzeCharacter}
                                            disabled={analyzing}
                                            className="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-bold hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 shadow-lg"
                                        >
                                            {analyzing ? 'AI Î∂ÑÏÑù Ï§ë...' : 'AI Î∂ÑÏÑù ÏãúÏûë'}
                                        </button>
                                    </div>
                                )}

                                {aiAnalysis && (
                                    <div>
                                        <div className="bg-slate-700/50 rounded-xl p-6 mb-6 border border-slate-600">
                                            <div className="prose prose-invert max-w-none">
                                                <div className="whitespace-pre-wrap text-gray-200 leading-relaxed">
                                                    {aiAnalysis}
                                                </div>
                                            </div>
                                        </div>

                                        <button
                                            onClick={analyzeCharacter}
                                            disabled={analyzing}
                                            className="w-full py-3 bg-slate-700 text-white rounded-lg font-medium hover:bg-slate-600 transition-all disabled:opacity-50"
                                        >
                                            Ïû¨Î∂ÑÏÑù
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Î†åÎçîÎßÅ
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Aion2PowerGuideApp />);
    </script>
</body>
</html>
